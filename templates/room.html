{% extends 'base.html' %} {% block content %}

<div id="room-stats" style="padding: 10px; border-bottom: 1px solid #ccc;">
  <strong>Room Stats:</strong>
  Messages sent: <span id="msg-count">0</span> | 
  Active users: <span id="user-count">0</span> | 
  Peak users: <span id="peak-count">0</span>
</div>



<div class="message-box">
    <h2>Chat Room: {{code}}</h2> 
    <div class="messages" id="messages"></div>
    <div class="inputs">
        <input type="text" 
        rows="3" 
        placeholder="Message" 
        name="message" 
        id="message" 
        />

        <button type="button"
        name="send"
        id="send-btn"
        onClick="sendMessage()"> Send </button>
    </div>

</div>



<script type="text/javascript">
    var socketio = io();

    const messages = document.getElementById("messages")

    const createMessage = (name, msg, msgTimeStamp) => {
        const time = msgTimeStamp || "";
        const content = `
        <div class="text">
            <span><strong>${name}</strong>: ${msg}</span>
            <span class="muted">${time}</span>
        </div>
        `;
        messages.innerHTML += content;
        messages.scrollTop = messages.scrollHeight;
    };

    socketio.on("message", (data) => {
        createMessage(data.name, data.message, data.timestamp);
    });

    const sendMessage = () => {
        const message = document.getElementById("message")
        if (message.value == "") return;
        socketio.emit("message",{data: message.value})
        message.value = "";
    };


    function updateStats(data) {
        document.getElementById("msg-count").innerText = data.messages;
        document.getElementById("user-count").innerText = data.users;
        document.getElementById("peak-count").innerText = data.peak;
    }


    socketio.on("connect", () => {
        socketio.emit("request_stats");
        setInterval(() => {
            socketio.emit("request_stats");
        }, 5000);
    });

    socketio.on("room_stats", (data) => {
        updateStats(data);
    });

    socketio.on("message", () => {
        socketio.emit("request_stats");
    });



</script>



{% for msg in messages%}
    <script type="text/javascript">
        createMessage("{{msg.name}}", "{{msg.message}}","{{msg.timestamp}}")
    </script>

{% endfor %}
{% endblock %}